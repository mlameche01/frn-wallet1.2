<script>

const TOKEN_ADDRESS = "0x07221c2D1dc1D5485Bf069871E2820864B4948F7";
const RPC = "https://rpc.ankr.com/polygon"; // meilleur RPC

let provider, wallet, signer, token;
let TOKEN_DECIMALS = 18;

window.onload = ()=>{
  const pin = localStorage.getItem("dzd_pin");
  if(pin){
    document.getElementById("pinLoginBox").style.display="block";
  }else{
    document.getElementById("pinSetupBox").style.display="block";
  }
};

async function initWallet(){

  provider = new ethers.providers.JsonRpcProvider(RPC);

  const savedPK = localStorage.getItem("dzd_key");
  wallet = savedPK ? new ethers.Wallet(savedPK) : ethers.Wallet.createRandom();

  if(!savedPK){
    localStorage.setItem("dzd_key",wallet.privateKey);
  }

  signer = wallet.connect(provider);

  // ABI ERC20 minimale standard
  const ERC20_ABI = [
    "function balanceOf(address) view returns (uint256)",
    "function decimals() view returns (uint8)",
    "function symbol() view returns (string)"
  ];

  token = new ethers.Contract(TOKEN_ADDRESS, ERC20_ABI, provider);

  document.getElementById("address").innerText = wallet.address;
  document.getElementById("privateKeyBox").value = wallet.privateKey;

  QRCode.toCanvas(document.getElementById("qrcode"), wallet.address);

  try{
    TOKEN_DECIMALS = await token.decimals();
    console.log("Decimals:", TOKEN_DECIMALS);

    const symbol = await token.symbol();
    console.log("Symbol:", symbol);

  }catch(err){
    console.error("Erreur lecture token:", err);
    TOKEN_DECIMALS = 18;
  }

  updateBalance();
}

async function updateBalance(){
  try{

    console.log("Adresse test:", wallet.address);

    const raw = await token.balanceOf(wallet.address);

    console.log("Raw balance:", raw.toString());

    const formatted = ethers.utils.formatUnits(raw, TOKEN_DECIMALS);

    document.getElementById("balance").innerText = formatted;

  }catch(err){
    console.error("Erreur balance:", err);
    document.getElementById("balance").innerText="0";
  }
}

</script>
